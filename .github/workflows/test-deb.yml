name: Test nxsbom-cli (.deb package on APT-based distros)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/test-deb.yml"
  pull_request:
    paths:
      - ".github/workflows/test-deb.yml"

jobs:
  test-cli-deb:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            container: ""
          - os: debian
            container: "debian:latest"
          - os: kali
            container: "kalilinux/kali-rolling"
          - os: linuxmint
            container: "linuxmintd/mint20.2-amd64"

    runs-on: ${{ matrix.container == '' && matrix.os || 'ubuntu-24.04' }}

    # enable privileged mode for dpkg inside containers
    container:
      image: ${{ matrix.container }}
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      ###########################################################
      # INSTALL DEPENDENCIES ON APT-BASED DISTROS
      ###########################################################

      - name: Install deps (Ubuntu host)
        if: matrix.container == ''
        run: |
          sudo apt update
          sudo apt install -y curl jq file gdebi-core apt-transport-https

      - name: Install deps (APT container distros)
        if: matrix.container != ''
        run: |
          apt update
          apt install -y curl jq file gdebi-core apt-transport-https || true

      ###########################################################
      # DOWNLOAD .deb PACKAGE
      ###########################################################

      - name: Download nxsbom-cli .deb package
        run: |
          mkdir -p cli_dir
          curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli_e594b4d-dev_amd64.deb" \
            -o cli_dir/nxsbom-cli.deb
          ls -al cli_dir

      ###########################################################
      # INSTALL THE .deb PACKAGE
      ###########################################################

      - name: Install .deb package
        run: |
          echo "Installing .deb on ${{ matrix.os }}"
          dpkg -i cli_dir/nxsbom-cli.deb || true
          apt --fix-broken install -y || true
          dpkg -l | grep nxsbom || true

      ###########################################################
      # DETECT INSTALLED BINARY (nxsbom)
      ###########################################################

      - name: Detect installed nxsbom binary
        run: |
          BIN=$(command -v nxsbom || true)

          if [ -z "$BIN" ]; then
            echo "âŒ ERROR: nxsbom binary not found"
            ls -R /usr/local/bin || true
            ls -R /usr/bin || true
            exit 1
          fi

          echo "Binary found at: $BIN"
          echo "BIN=$BIN" >> $GITHUB_ENV

      ###########################################################
      # RUN CLI TEST
      ###########################################################

      - name: Run CLI Test
        run: |
          echo "Running on OS: ${{ matrix.os }}"
          $BIN --version || $BIN -h || true
