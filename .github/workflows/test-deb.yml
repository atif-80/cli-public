name: Test nxsbom-cli (.deb package on APT-based distros)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/test-deb.yml"
  pull_request:
    paths:
      - ".github/workflows/test-deb.yml"

jobs:
  test-cli-deb:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            container: ""
          - os: debian
            container: "debian:latest"
          - os: kali
            container: "kalilinux/kali-rolling"
          - os: linuxmint
            container: "linuxmintd/mint20.2-amd64"

    runs-on: ${{ matrix.container == '' && matrix.os || 'ubuntu-24.04' }}

    container:
      image: ${{ matrix.container }}
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      #############################################################
      # INSTALL DEPENDENCIES (FIX: added binutils for `ar`)
      #############################################################

      - name: Install deps (Ubuntu host)
        if: matrix.container == ''
        run: |
          sudo apt update
          sudo apt install -y curl jq file arj tar xz-utils gdebi-core binutils

      - name: Install deps (APT container distros)
        if: matrix.container != ''
        run: |
          apt update
          apt install -y curl jq file arj tar xz-utils gdebi-core binutils || true

      #############################################################
      # DOWNLOAD .deb PACKAGE
      #############################################################

      - name: Download nxsbom-cli .deb package
        run: |
          mkdir -p cli_dir
          curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli_e594b4d-dev_amd64.deb" \
            -o cli_dir/nxsbom-cli.deb
          ls -al cli_dir

      #############################################################
      # TRY TO INSTALL USING DPKG
      #############################################################

      - name: Attempt dpkg install
        id: dpkg_install
        continue-on-error: true
        run: |
          echo "Installing .deb on ${{ matrix.os }}"
          dpkg -i cli_dir/nxsbom-cli.deb || true
          apt --fix-broken install -y || true

          if command -v nxsbom >/dev/null 2>&1; then
            echo "installed=true" >> $GITHUB_OUTPUT
          else
            echo "installed=false" >> $GITHUB_OUTPUT
          fi

      #############################################################
      # FALLBACK EXTRACTION (FIXED)
      #############################################################

      - name: Fallback extract .deb manually
        if: steps.dpkg_install.outputs.installed == 'false'
        run: |
          echo "⚠️ dpkg failed — performing manual extraction"
          cd cli_dir

          ar x nxsbom-cli.deb || true

          if ls data.tar.xz >/dev/null 2>&1; then
            tar -xf data.tar.xz
          elif ls data.tar.gz >/dev/null 2>&1; then
            tar -xf data.tar.gz
          else
            echo "❌ No data.tar archive found inside the .deb"
            exit 1
          fi

          echo "Searching for nxsbom binary..."
          find . -type f -name "nxsbom*" -exec chmod +x {} \; -exec echo "FOUND {}" \; | tee ../binary.txt

          BIN=$(grep FOUND ../binary.txt | awk '{print $2}' | head -n1)

          if [ -z "$BIN" ]; then
            echo "❌ No binary found inside extracted .deb"
            exit 1
          fi

          echo "Using extracted binary: $BIN"
          echo "BIN=$(realpath $BIN)" >> $GITHUB_ENV

      #############################################################
      # DETECT FINAL INSTALLED OR EXTRACTED BINARY
      #############################################################

      - name: Detect final binary path
        if: steps.dpkg_install.outputs.installed == 'true'
        run: |
          BIN=$(command -v nxsbom)
          echo "Installed binary located at: $BIN"
          echo "BIN=$BIN" >> $GITHUB_ENV

      #############################################################
      # RUN CLI TEST
      #############################################################

      - name: Run CLI Test
        run: |
          echo "Running on OS: ${{ matrix.os }}"
          echo "Using binary: $BIN"
          $BIN --version || $BIN -h || true
