name: Test nxsbom-cli glibc-aarch64 TAR on ARM64 Distros

on:
  workflow_dispatch:

jobs:
  test-glibc-aarch64-tar:
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-arm
            image: "ubuntu:24.04"

          - os: debian-arm
            image: "debian:latest"

          - os: fedora-arm
            image: "fedora:39"

          - os: centos-arm
            image: "quay.io/centos/centos:stream9"

          - os: rhel-arm
            image: "registry.access.redhat.com/ubi9/ubi"  # CHANGED: from ubi-minimal to ubi

          - os: alma-arm
            image: "almalinux:9"

          - os: rocky-arm
            image: "rockylinux:9"

          - os: oracle-arm
            image: "oraclelinux:9"

    steps:
      ###################################################################
      # Enable QEMU ARM64 emulation
      ###################################################################
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      ###################################################################
      # Run ARM64 container with multi-arch support
      ###################################################################
      - name: Run ARM64 test container
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ matrix.image }}
          options: "--platform linux/arm64"
          shell: bash
          run: |
            echo ">>> Running on ${{ matrix.os }}"
            uname -a || true
            cat /etc/os-release || true

            ############################################################
            # Install dependencies (apt/yum/dnf/zypper)
            ############################################################
            if command -v apt >/dev/null 2>&1; then
              apt update -y || true
              apt install -y curl tar gzip findutils file jq || true
            fi

            if command -v dnf >/dev/null 2>&1; then
              dnf install -y curl tar gzip findutils file jq || true
            fi

            if command -v yum >/dev/null 2>&1; then
              yum install -y curl tar gzip findutils file jq || true
            fi

            if command -v zypper >/dev/null 2>&1; then
              zypper -n install curl tar gzip findutils file jq || true
            fi

            ############################################################
            # Download TAR
            ############################################################
            mkdir -p cli_dir
            curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli-glibc-aarch64.tar.gz" \
              -o cli_dir/pkg.tar.gz

            echo "Downloaded package:"
            ls -lh cli_dir

            ############################################################
            # Extract TAR
            ############################################################
            cd cli_dir
            tar -xzf pkg.tar.gz

            echo "Extracted contents:"
            ls -R .

            ############################################################
            # Locate binary inside arm64-pkg/
            ############################################################
            BIN=$(find . -type f -name nxsbom | head -n 1 || true)

            if [ -z "$BIN" ]; then
              echo "❌ No nxsbom binary found!"
              exit 1
            fi

            chmod +x "$BIN"
            echo "Found binary at: $BIN"

            ############################################################
            # Run binary
            ############################################################
            echo ">>> Executing nxsbom on ${{ matrix.os }}"
            "$BIN" --help || "$BIN" -h || echo "⚠ glibc issue expected on non-glibc systems"

            echo "----- DONE -----"
