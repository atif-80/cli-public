name: Test nxsbom-cli x86_64 AppImage on 14 Linux distros

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/nxsbom-cli-x86_64AppImage.yml"
  pull_request:
    paths:
      - ".github/workflows/nxsbom-cli-x86_64AppImage.yml"

jobs:
  test-appimage:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            container: ""
          - os: debian
            container: "debian:latest"
          - os: fedora
            container: "fedora:latest"
          - os: arch
            container: "archlinux:latest"
          - os: kali
            container: "kalilinux/kali-rolling"
          - os: centos
            container: "quay.io/centos/centos:stream9"
          - os: rhel
            container: "registry.access.redhat.com/ubi9/ubi"
          - os: alma
            container: "almalinux:latest"
          - os: rocky
            container: "rockylinux:9"
          - os: oracle
            container: "oraclelinux:9"
          - os: opensuse
            container: "opensuse/leap:latest"
          - os: amazon
            container: "amazonlinux:2023"
          - os: alpine
            container: "alpine:latest"
          - os: linuxmint
            container: "linuxmintd/mint21-amd64"

    runs-on: ubuntu-24.04
    container: ${{ matrix.container }}

    steps:
      #######################################################
      # Fix Amazon & OpenSUSE tar BEFORE checkout
      #######################################################
      - name: Pre-install tar for Amazon & openSUSE BEFORE checkout
        if: matrix.os == 'amazon' || matrix.os == 'opensuse'
        run: |
          echo ">>> Installing tar for ${{ matrix.os }} before checkout"
          (yum install -y tar gzip || true)
          (dnf install -y tar gzip || true)
          (zypper -n install tar gzip || true)

      #######################################################
      # Checkout the repo
      #######################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      #######################################################
      # Install dependencies per distro
      #######################################################

      # Ubuntu host
      - name: Install deps (Ubuntu host)
        if: matrix.container == ''
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq file fuse3 libfuse3-3 tar gzip

      # Debian/Kali/LinuxMint
      - name: Install deps (Debian/Kali/LinuxMint)
        if: matrix.os == 'debian' || matrix.os == 'kali' || matrix.os == 'linuxmint'
        run: |
          apt update || true
          apt install -y curl jq file fuse3 libfuse3-3 tar gzip || true

      # Fedora & RPM family
      - name: Install deps (RPM family)
        if: matrix.os == 'fedora' || matrix.os == 'centos' || matrix.os == 'rhel' || matrix.os == 'alma' || matrix.os == 'rocky' || matrix.os == 'oracle' || matrix.os == 'amazon'
        run: |
          (dnf install -y curl jq file fuse fuse-libs fuse3-libs tar gzip || true)
          (yum install -y curl jq file fuse fuse-libs fuse3-libs tar gzip || true)

      # openSUSE
      - name: Install deps (openSUSE)
        if: matrix.os == 'opensuse'
        run: |
          zypper refresh
          zypper install -y curl jq file fuse3 fuse tar gzip || true

      # Arch
      - name: Install deps (Arch)
        if: matrix.os == 'arch'
        run: |
          pacman -Sy --noconfirm curl jq file fuse3 tar gzip || true

      # Alpine
      - name: Install deps (Alpine)
        if: matrix.os == 'alpine'
        run: |
          apk update
          apk add --no-cache curl jq file fuse fuse3 squashfs-tools tar gzip || true

      #######################################################
      # Download AppImage
      #######################################################
      - name: Download nxsbom-cli AppImage
        run: |
          mkdir -p cli_dir
          curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli-x86_64.AppImage" \
            -o cli_dir/nxsbom.AppImage
          chmod +x cli_dir/nxsbom.AppImage
          ls -al cli_dir

      #######################################################
      # Try running AppImage + fallback extraction
      #######################################################
      - name: Try native run + fallback extract
        run: |
          echo ">>> Running AppImage on ${{ matrix.os }}"

          cd cli_dir

          echo "Trying native execution..."
          ./nxsbom.AppImage --help || true

          echo "If native FUSE fails → extract"
          ./nxsbom.AppImage --appimage-extract || true

          echo ">>> Extracted files:"
          ls -R squashfs-root || true

          if [ -f squashfs-root/AppRun ]; then
            chmod +x squashfs-root/AppRun
            echo "Running extracted AppRun..."
            squashfs-root/AppRun --help || true
          else
            echo "❌ AppRun not found"
          fi

          echo "----- DONE -----"
