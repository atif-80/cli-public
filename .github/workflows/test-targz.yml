name: Test nxsbom-cli (.tar.gz) across 14 Linux distros

on:
  push:
    paths:
      - ".github/workflows/test-targz.yml"
  pull_request:
    paths:
      - ".github/workflows/test-targz.yml"
  workflow_dispatch:

jobs:
  test-tar:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            container: ""
          - os: fedora
            container: "fedora:latest"
          - os: debian
            container: "debian:latest"
          - os: arch
            container: "archlinux:latest"
          - os: kali
            container: "kalilinux/kali-rolling"
          - os: centos
            container: "quay.io/centos/centos:stream9"
          - os: rhel
            container: "registry.access.redhat.com/ubi9/ubi"
          - os: alma
            container: "almalinux:latest"
          - os: oracle
            container: "oraclelinux:9"
          - os: amazon
            container: "amazonlinux:2023"
          - os: rocky
            container: "rockylinux:9"
          - os: opensuse
            container: "opensuse/leap:latest"
          - os: alpine
            container: "alpine:latest"
          - os: clearlinux
            container: "clearlinux:latest"

    runs-on: ubuntu-24.04
    container: ${{ matrix.container }}

    steps:
      #############################################
      # Fix checkout tar missing for openSUSE & Amazon
      #############################################
      - name: Pre-install tar for container (fix checkout)
        if: ${{ matrix.os == 'opensuse' || matrix.os == 'amazon' }}
        run: |
          if command -v zypper >/dev/null; then
            zypper refresh || true
            zypper install -y tar gzip || true
          elif command -v yum >/dev/null; then
            yum install -y tar gzip || true
          fi

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Print environment
        run: |
          echo "Matrix OS: ${{ matrix.os }}"
          cat /etc/os-release || true


      ###########################################################
      # INSTALL DEPS
      ###########################################################

      - name: Ubuntu Host deps
        if: ${{ matrix.container == '' }}
        run: |
          sudo apt update -y
          sudo apt install -y curl jq file tar gzip libstdc++6 findutils

      - name: Debian-family deps
        if: ${{ matrix.os == 'debian' || matrix.os == 'kali' }}
        run: |
          apt update -y
          apt install -y curl jq file tar gzip libstdc++6 findutils || true

      - name: Arch deps
        if: ${{ matrix.os == 'arch' }}
        run: |
          pacman -Sy --noconfirm curl jq file tar gzip gcc-libs findutils

      - name: openSUSE deps
        if: ${{ matrix.os == 'opensuse' }}
        run: |
          zypper refresh
          zypper install -y curl jq file tar gzip libstdc++6 findutils || true

      - name: Alpine deps
        if: ${{ matrix.os == 'alpine' }}
        run: |
          apk update
          apk add --no-cache curl jq file tar gzip libgcc libstdc++ gcompat findutils

      - name: ClearLinux deps
        if: ${{ matrix.os == 'clearlinux' }}
        run: |
          swupd bundle-add os-core file-utils curl jq c-basic dev-utils libstdc++ findutils

      - name: RPM deps
        if: ${{ matrix.os == 'fedora' || matrix.os == 'centos' || matrix.os == 'rhel'
             || matrix.os == 'alma' || matrix.os == 'oracle' || matrix.os == 'rocky'
             || matrix.os == 'amazon' }}
        run: |
          (dnf install -y curl jq tar gzip file findutils || true)
          (yum install -y curl jq tar gzip file findutils || true)

      # Amazon Linux REQUIRED FIX
      - name: Fix Amazon Linux missing tools
        if: ${{ matrix.os == 'amazon' }}
        run: |
          yum install -y findutils tar gzip file || true


      ###########################################################
      # DOWNLOAD
      ###########################################################
      - name: Download tar.gz
        run: |
          mkdir -p cli_dir
          curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-e594b4d-dev-glibc-x86_64.tar.gz" \
            -o cli_dir/nxsbom-cli.tar.gz
          ls -al cli_dir


      ###########################################################
      # EXTRACT BINARY
      ###########################################################
      - name: Extract and install binary
        run: |
          cd cli_dir
          tar -xzf nxsbom-cli.tar.gz

          echo ">>> Detecting ELF binary"
          if command -v file >/dev/null; then
            BINARY=$(find . -type f -exec sh -c 'file -b "$1" | grep ELF >/dev/null && echo "$1"' _ {} \; | head -n 1)
          else
            BINARY=$(find . -type f -exec sh -c 'head -c4 "$1" | grep -q "$(printf "\x7FELF")" && echo "$1"' _ {} \; | head -n 1)
          fi

          if [ -z "$BINARY" ]; then
            echo "‚ùå No ELF binary found"
            exit 1
          fi

          echo "Found ELF: $BINARY"
          chmod +x "$BINARY"
          cp "$BINARY" /usr/local/bin/nxsbom-cli


      ###########################################################
      # RUN HELP TEST
      ###########################################################
      - name: Run CLI Test
        run: |
          echo "Running on ${{ matrix.os }}"
          nxsbom-cli --help || nxsbom-cli --version || true
