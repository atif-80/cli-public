name: Test nxsbom-cli (MUSL binary) across 14 Linux distros

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/test-musl.yml"
  pull_request:
    paths:
      - ".github/workflows/test-musl.yml"

jobs:
  test-musl:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            container: ""
          - os: linuxmint
            container: "linuxmintd/mint21.3-amd64"
          - os: fedora
            container: "fedora:latest"
          - os: debian
            container: "debian:latest"
          - os: arch
            container: "archlinux:latest"
          - os: kali
            container: "kalilinux/kali-rolling"
          - os: centos
            container: "quay.io/centos/centos:stream9"
          - os: rhel
            container: "registry.access.redhat.com/ubi9/ubi"
          - os: alma
            container: "almalinux:latest"
          - os: oracle
            container: "oraclelinux:9"
          - os: amazon
            container: "amazonlinux:2023"
          - os: rocky
            container: "rockylinux:9"
          - os: opensuse
            container: "opensuse/leap:latest"
          - os: alpine
            container: "alpine:latest"

    runs-on: ${{ matrix.container == '' && matrix.os || 'ubuntu-24.04' }}
    container: ${{ matrix.container }}

    steps:
      # --------------------------------------------------------------------
      # Fix missing tools BEFORE checkout (Amazon, openSUSE, Mint, etc.)
      # --------------------------------------------------------------------
      - name: Pre-install base tools (curl, tar, file, jq)
        shell: sh
        run: |
          echo ">>> Installing base tools for ${{ matrix.os }}"
          (apt-get update && apt-get install -y curl tar file jq 2>/dev/null) || true
          (yum install -y curl tar file jq 2>/dev/null) || true
          (dnf install -y curl tar file jq 2>/dev/null) || true
          (zypper install -y curl tar file jq 2>/dev/null) || true
          (apk add --no-cache curl tar file jq 2>/dev/null) || true

      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------------------
      # Download MUSL binary
      # --------------------------------------------------------------------
      - name: Download MUSL binary
        run: |
          mkdir -p cli_dir
          echo ">>> Downloading nxsbom-musl-x86_64"
          curl -L -f \
            "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-musl-x86_64" \
            -o cli_dir/nxsbom-musl
          chmod +x cli_dir/nxsbom-musl
          ls -lh cli_dir

      # --------------------------------------------------------------------
      # Execute MUSL binary using --help
      # --------------------------------------------------------------------
      - name: Run MUSL binary
        shell: sh
        run: |
          echo ">>> Running MUSL binary on ${{ matrix.os }}"
          if ./cli_dir/nxsbom-musl --help >/dev/null 2>&1; then
            echo "üéâ MUSL binary executed successfully on ${{ matrix.os }}"
          else
            echo "‚ö†Ô∏è MUSL binary failed on ${{ matrix.os }} (expected for some distros)"
          fi
          echo "----- Done -----"
