name: Test nxsbom-cli (.rpm) on RPM-based distros

on:
  workflow_dispatch:

  push:
    paths:
      - ".github/workflows/test-rpm.yml"

  pull_request:
    paths:
      - ".github/workflows/test-rpm.yml"

jobs:
  test-rpm:
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: fedora
            container: "fedora:latest"
            pkgmgr: dnf

          - distro: centos
            container: "quay.io/centos/centos:stream9"
            pkgmgr: yum

          - distro: rhel
            container: "registry.access.redhat.com/ubi9/ubi"
            pkgmgr: yum

          - distro: alma
            container: "almalinux:latest"
            pkgmgr: yum

          - distro: rocky
            container: "rockylinux:9"
            pkgmgr: yum

          - distro: oracle
            container: "oraclelinux:9"
            pkgmgr: yum

          - distro: amazon
            container: "amazonlinux:2023"
            pkgmgr: yum

          - distro: opensuse
            container: "opensuse/leap:latest"
            pkgmgr: zypper

    runs-on: ubuntu-24.04
    container: ${{ matrix.container }}

    steps:
      ##########################################################
      # Fix Amazon Linux & openSUSE BEFORE checkout
      # (tar missing → GitHub checkout fails)
      ##########################################################
      - name: Pre-install tar for Amazon & openSUSE BEFORE checkout
        if: matrix.distro == 'amazon' || matrix.distro == 'opensuse'
        run: |
          echo ">>> Pre-installing tar, gzip for ${ { matrix.distro } }"
          (yum install -y tar gzip || true)
          (dnf install -y tar gzip || true)
          (zypper -n install tar gzip || true)

      ##########################################################
      # Checkout repo
      ##########################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print environment
        run: |
          echo "Distro: ${{ matrix.distro }}"
          cat /etc/os-release || true
          uname -a

      ##########################################################
      # Install required dependencies per distro
      ##########################################################
      - name: Install deps (Fedora)
        if: matrix.distro == 'fedora'
        run: |
          dnf -y update || true
          dnf -y install curl jq file which unzip gzip tar libstdc++.so.6 || true

      - name: Install deps (CentOS Stream)
        if: matrix.distro == 'centos'
        run: |
          yum -y update || true
          yum -y install curl jq file which unzip gzip tar libstdc++.so.6 || true

      - name: Install deps (RHEL UBI)
        if: matrix.distro == 'rhel'
        run: |
          yum -y update || true
          yum -y install curl jq file which unzip gzip tar libstdc++.so.6 || true

      - name: Install deps (AlmaLinux)
        if: matrix.distro == 'alma'
        run: |
          yum -y update || true
          yum -y install curl jq file which unzip gzip tar libstdc++.so.6 || true

      - name: Install deps (Rocky)
        if: matrix.distro == 'rocky'
        run: |
          yum -y update || true
          yum -y install curl jq file which unzip gzip tar libstdc++.so.6 || true

      - name: Install deps (Oracle Linux)
        if: matrix.distro == 'oracle'
        run: |
          yum -y update || true
          yum -y install curl jq file which unzip gzip tar libstdc++.so.6 || true

      - name: Install deps (Amazon Linux)
        if: matrix.distro == 'amazon'
        run: |
          yum -y update || true
          yum -y install curl jq file which unzip gzip tar libstdc++.so.6 || true

      - name: Install deps (openSUSE)
        if: matrix.distro == 'opensuse'
        run: |
          zypper refresh || true
          zypper -n install curl jq file which gzip tar unzip libstdc++6 || true

      ##########################################################
      # Download RPM
      ##########################################################
      - name: Download nxsbom-cli RPM
        run: |
          mkdir -p cli_dir
          curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli-e594b4d_dev-1.x86_64.rpm" \
            -o cli_dir/nxsbom-cli.rpm
          ls -lh cli_dir

      ##########################################################
      # Install RPM using correct package manager
      ##########################################################
      - name: Install RPM (dnf)
        if: matrix.pkgmgr == 'dnf'
        run: |
          dnf install -y ./cli_dir/nxsbom-cli.rpm || rpm -Uvh ./cli_dir/nxsbom-cli.rpm || true

      - name: Install RPM (yum)
        if: matrix.pkgmgr == 'yum'
        run: |
          yum install -y ./cli_dir/nxsbom-cli.rpm || rpm -Uvh ./cli_dir/nxsbom-cli.rpm || true

      - name: Install RPM (zypper)
        if: matrix.pkgmgr == 'zypper'
        run: |
          zypper --non-interactive install ./cli_dir/nxsbom-cli.rpm || rpm -Uvh ./cli_dir/nxsbom-cli.rpm || true

      ##########################################################
      # Locate binary (installed as "nxsbom")
      ##########################################################
      - name: Locate installed binary
        run: |
          BIN=$(command -v nxsbom || true)
          echo "Found: $BIN"
          if [ -z "$BIN" ]; then
            echo "❌ Binary not found (expected for non-Fedora due to GLIBC issue)"
            exit 1
          fi
          echo "BIN=$BIN" >> $GITHUB_ENV

      ##########################################################
      # Run smoke test
      ##########################################################
      - name: Run nxsbom smoke test
        run: |
          echo "Testing nxsbom..."
          $BIN --version || $BIN -h || true

