name: Test nxsbom-cli (.rpm) on RPM-based distros

on:
  workflow_dispatch:

  push:
    paths:
      - ".github/workflows/test-rpm.yml"

  pull_request:
    paths:
      - ".github/workflows/test-rpm.yml"

jobs:
  test-rpm:
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: fedora
            container: "fedora:latest"
            pkgmgr: dnf

          - distro: centos
            container: "quay.io/centos/centos:stream9"
            pkgmgr: yum

          - distro: rhel
            container: "registry.access.redhat.com/ubi9/ubi"
            pkgmgr: yum

          - distro: alma
            container: "almalinux:latest"
            pkgmgr: yum

          - distro: rocky
            container: "rockylinux:9"
            pkgmgr: yum

          - distro: oracle
            container: "oraclelinux:9"
            pkgmgr: yum

          - distro: amazon
            container: "amazonlinux:2023"
            pkgmgr: yum

          - distro: opensuse
            container: "opensuse/leap:latest"
            pkgmgr: zypper

    runs-on: ubuntu-24.04
    container: ${{ matrix.container }}

    steps:
      - name: Install base tools
        run: |
          echo ">>> Installing required system tools"
          (yum install -y tar gzip file curl jq libstdc++.so.6 which || true)
          (dnf install -y tar gzip file curl jq libstdc++.so.6 which || true)
          (zypper -n install tar gzip file curl jq libstdc++6 which || true)
          ldconfig || true
          yum install -y tar gzip
          zypper install -y tar gzip

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download RPM
        run: |
          mkdir -p cli_dir
          curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli-e594b4d_dev-1.x86_64.rpm" \
            -o cli_dir/nxsbom-cli.rpm
          ls -lh cli_dir

      - name: Install RPM
        run: |
          if [ "${{ matrix.pkgmgr }}" = "dnf" ]; then
            dnf install -y ./cli_dir/nxsbom-cli.rpm || rpm -Uvh ./cli_dir/nxsbom-cli.rpm
          elif [ "${{ matrix.pkgmgr }}" = "yum" ]; then
            yum install -y ./cli_dir/nxsbom-cli.rpm || rpm -Uvh ./cli_dir/nxsbom-cli.rpm
          elif [ "${{ matrix.pkgmgr }}" = "zypper" ]; then
            zypper --non-interactive install ./cli_dir/nxsbom-cli.rpm || rpm -Uvh ./cli_dir/nxsbom-cli.rpm
          fi

          echo ">>> Installed files:"
          rpm -ql nxsbom-cli-e594b4d_dev-1.x86_64 || rpm -qlp cli_dir/nxsbom-cli.rpm

      - name: Locate installed binary
        id: locate
        run: |
          BIN=$(command -v nxsbom || true)

          if [ -z "$BIN" ]; then
            echo "âŒ ERROR: 'nxsbom' binary not found in PATH"
            exit 1
          fi

          echo "Binary found at: $BIN"
          echo "BIN=$BIN" >> $GITHUB_ENV

      - name: Run smoke test
        run: |
          echo "Running smoke test:"
          $BIN --version || $BIN -h || true
