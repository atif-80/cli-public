name: Test nxsbom-cli glibc-x86_64 TAR on 14 Linux distros

on:
  workflow_dispatch:

jobs:
  test-glibc-tar:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            container: ""

          - os: debian
            container: "debian:latest"

          - os: fedora
            container: "fedora:latest"

          - os: arch
            container: "archlinux:latest"

          - os: kali
            container: "kalilinux/kali-rolling"

          - os: centos
            container: "quay.io/centos/centos:stream9"

          - os: rhel
            container: "registry.access.redhat.com/ubi9/ubi"

          - os: alma
            container: "almalinux:latest"

          - os: rocky
            container: "rockylinux:9"

          - os: oracle
            container: "oraclelinux:9"

          - os: amazon
            container: "amazonlinux:2023"

          - os: opensuse
            container: "opensuse/leap:latest"

          - os: alpine
            container: "alpine:latest"

          - os: linuxmint
            container: "linuxmintd/mint21-amd64"

    runs-on: ${{ matrix.container == '' && matrix.os || 'ubuntu-24.04' }}
    container: ${{ matrix.container }}

    steps:
    ###########################################################################
    # PRE-INSTALL TAR FOR AMAZON + OPENSUSE (BEFORE CHECKOUT)
    ###########################################################################
    - name: Fix tar on Amazon & openSUSE
      if: matrix.os == 'amazon' || matrix.os == 'opensuse'
      run: |
        echo ">>> Pre-install tar for ${matrix.os}"
        (yum install -y tar gzip || true)
        (dnf install -y tar gzip || true)
        (zypper -n install tar gzip || true)

    ###########################################################################
    # CHECKOUT
    ###########################################################################
    - name: Checkout repository
      uses: actions/checkout@v4

    ###########################################################################
    # INSTALL DEPENDENCIES PER DISTRO
    ###########################################################################
    - name: Install deps (Debian/Ubuntu/Kali/LinuxMint)
      if: matrix.os == 'ubuntu' || matrix.os == 'debian' || matrix.os == 'kali' || matrix.os == 'linuxmint'
      run: |
        apt update || true
        apt install -y curl jq file tar gzip || true

    - name: Install deps (RPM Distros)
      if: matrix.os == 'fedora' || matrix.os == 'centos' || matrix.os == 'rhel' || matrix.os == 'alma' || matrix.os == 'rocky' || matrix.os == 'oracle' || matrix.os == 'amazon'
      run: |
        yum install -y curl jq file tar gzip || \
        dnf install -y curl jq file tar gzip || true

    - name: Install deps (Arch Linux)
      if: matrix.os == 'arch'
      run: |
        pacman -Sy --noconfirm curl jq file tar gzip || true

    - name: Install deps (openSUSE)
      if: matrix.os == 'opensuse'
      run: |
        zypper refresh || true
        zypper -n install curl jq file tar gzip || true

    - name: Install deps (Alpine)
      if: matrix.os == 'alpine'
      run: |
        apk update
        apk add --no-cache curl jq file tar gzip

    ###########################################################################
    # DOWNLOAD TARBALL
    ###########################################################################
    - name: Download nxsbom-cli glibc-x86_64 TAR
      run: |
        mkdir -p cli_dir
        curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli-glibc-x86_64.tar.gz" \
          -o cli_dir/nxsbom-glibc.tar.gz
        ls -lh cli_dir

    ###########################################################################
    # EXTRACT TAR & DETECT BINARY
    ###########################################################################
    - name: Extract tarball
      run: |
        cd cli_dir
        tar -xzf nxsbom-glibc.tar.gz || true
        echo ">>> Extracted:"
        ls -R .

    - name: Locate binary
      run: |
        echo ">>> Searching for nxsbom inside extracted dirs..."
        BIN=$(find cli_dir -type f -name nxsbom | head -n 1 || true)

        if [ -z "$BIN" ]; then
          echo "❌ No nxsbom binary found!"
          exit 1
        fi

        echo "FOUND_BIN=$BIN" >> $GITHUB_ENV
        echo "Found at: $BIN"

    ###########################################################################
    # RUN BINARY (FIXED WORKDIR EXECUTION)
    ###########################################################################
    - name: Execute binary with --help
      run: |
        echo ">>> Executing binary on OS: ${{ matrix.os }}"

        BIN="${FOUND_BIN}"
        BIN_DIR=$(dirname "$BIN")
        BIN_FILE=$(basename "$BIN")

        echo "Binary dir: $BIN_DIR"
        echo "Binary file: $BIN_FILE"

        chmod +x "$BIN"

        # Correct execution with directory change
        bash -c "cd $BIN_DIR && ./$BIN_FILE --help" || \
        bash -c "cd $BIN_DIR && ./$BIN_FILE -h" || \
        echo "⚠ Expected loader/glibc issue on ${{ matrix.os }}"

        echo "----- DONE -----"

