name: Test nxsbom-cli glibc-x86_64 TAR on 14 Linux distros

on:
  workflow_dispatch:

jobs:
  test-glibc-tar:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            container: ""
          - os: debian
            container: "debian:latest"
          - os: kali
            container: "kalilinux/kali-rolling"
          - os: linuxmint
            container: "linuxmintd/mint21-amd64"
          - os: fedora
            container: "fedora:latest"
          - os: arch
            container: "archlinux:latest"
          - os: centos
            container: "quay.io/centos/centos:stream9"
          - os: rhel
            container: "registry.access.redhat.com/ubi9/ubi"
          - os: alma
            container: "almalinux:latest"
          - os: rocky
            container: "rockylinux:9"
          - os: oracle
            container: "oraclelinux:9"
          - os: amazon
            container: "amazonlinux:2023"
          - os: opensuse
            container: "opensuse/leap:latest"
          - os: alpine
            container: "alpine:latest"

    runs-on: ${{ matrix.container == '' && 'ubuntu-24.04' || 'ubuntu-24.04' }}
    container: ${{ matrix.container }}

    steps:
      - name: Pre-install tar on Amazon/openSUSE
        if: matrix.os == 'amazon' || matrix.os == 'opensuse'
        run: |
          echo ">>> Fixing tar issue on ${{ matrix.os }}"
          (yum install -y tar gzip || true)
          (dnf install -y tar gzip || true)
          (zypper install -y tar gzip || true)

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Print environment
        run: |
          echo "OS: ${{ matrix.os }}"
          cat /etc/*release || true

      - name: Install deps
        run: |
          case "${{ matrix.os }}" in
            ubuntu|debian|kali|linuxmint)
              apt update || true
              apt install -y curl jq tar gzip file || true
              ;;
            fedora)
              dnf install -y curl jq tar gzip file || true
              ;;
            centos|rhel|alma|rocky|oracle|amazon)
              yum install -y curl jq tar gzip file || true
              ;;
            opensuse)
              zypper refresh || true
              zypper install -y curl jq tar gzip file || true
              ;;
            arch)
              pacman -Sy --noconfirm curl jq tar gzip file || true
              ;;
            alpine)
              apk update
              apk add --no-cache curl jq tar gzip file || true
              ;;
          esac

      - name: Download TAR
        run: |
          mkdir -p cli_dir
          curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli-glibc-x86_64.tar.gz" \
            -o cli_dir/nxsbom-glibc.tar.gz

      - name: Extract TAR
        run: |
          cd cli_dir
          tar -xzf nxsbom-glibc.tar.gz
          
          echo ">>> Extracted contents:"
          ls -R .

      - name: Detect ELF binary
        run: |
          cd cli_dir
          BINARY=$(find . -type f -name nxsbom | head -n 1)
          if [ -z "$BINARY" ]; then
            echo "âŒ No binary found!"
            exit 1
          fi
          echo "Found binary: $BINARY"
          chmod +x "$BINARY"
          echo "BIN=$BINARY" >> $GITHUB_ENV

      - name: Run binary
        run: |
          echo ">>> Running $BIN on ${{ matrix.os }}"
          $BIN --help || $BIN -h || true

