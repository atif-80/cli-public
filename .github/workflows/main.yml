name: Test nxsbom-cli on Linux

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  ubuntu-latest:
    name: Test on ubuntu:latest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y curl unzip file

      - name: Download CLI
        run: |
          echo "Downloading bundle.zip ..."
          curl -H "Authorization: Bearer ${{ secrets.NXSBOM_ACCESS_TOKEN }}" \
                -L "https://api.nxsbom.dev/cli/download" \
                -o bundle.zip

      - name: Extract & Test
        run: |
          file bundle.zip
          unzip bundle.zip -d cli
          ls -lah cli
          chmod +x cli/nxsbom || true
          ./cli/nxsbom --version || echo "CLI run failed"

  ubuntu-24:
    name: Test on ubuntu:24.04
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y curl unzip file

      - name: Download CLI
        run: |
          curl -H "Authorization: Bearer ${{ secrets.NXSBOM_ACCESS_TOKEN }}" \
                -L "https://api.nxsbom.dev/cli/download" \
                -o bundle.zip

      - name: Extract & Test
        run: |
          file bundle.zip
          unzip bundle.zip -d cli
          ls -lah cli
          chmod +x cli/nxsbom || true
          ./cli/nxsbom --version || echo "CLI run failed"

  docker-linux:
    name: Test on ${{ matrix.os }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [debian:latest, fedora:latest, rockylinux:9]

    steps:
      - uses: actions/checkout@v4

      - name: Run test in Docker
        run: |
          echo "Testing in ${{ matrix.os }}"
          docker run --rm \
            -e NXSBOM_ACCESS_TOKEN=${{ secrets.NXSBOM_ACCESS_TOKEN }} \
            -v $PWD:/mnt/work \
            ${{ matrix.os }} \
            /bin/sh -c "
              cd /mnt/work &&
              if command -v apt >/dev/null 2>&1; then apt update && apt install -y curl unzip file; fi &&
              if command -v dnf >/dev/null 2>&1; then dnf install -y curl unzip file; fi &&
              if command -v microdnf >/dev/null 2>&1; then microdnf install -y curl unzip file; fi &&
              echo 'Downloading...' &&
              curl -H 'Authorization: Bearer '$NXSBOM_ACCESS_TOKEN \
                   -L 'https://api.nxsbom.dev/cli/download' \
                   -o bundle.zip &&
              file bundle.zip &&
              unzip bundle.zip -d cli &&
              chmod +x cli/nxsbom || true &&
              ./cli/nxsbom --version || echo 'CLI failed'
            "
