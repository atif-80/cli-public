name: Test nxsbom-cli (Ubuntu + Docker matrix)

on:
  workflow_dispatch:
  push:

jobs:
  test-cli:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]

    env:
      RELEASE_REPO: atif-80/cli-public
      ASSET_NAME: nxsbom-cli
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Latest Release Asset URL
      id: get_asset
      run: |
        API="https://api.github.com/repos/${RELEASE_REPO}/releases/latest"

        echo "Querying $API"
        ASSET_URL=$(curl -s -H "Authorization: token $GITHUB_TOKEN" $API \
          | jq -r ".assets[] | select(.name==\"${ASSET_NAME}\") | .browser_download_url")

        if [ -z "$ASSET_URL" ]; then
          echo "âŒ No asset found matching '${ASSET_NAME}'"
          exit 1
        fi

        echo "ASSET_URL=$ASSET_URL" >> $GITHUB_ENV

    - name: Download asset
      run: |
        echo "Downloading asset from: $ASSET_URL"
        curl -L -o bundle "$ASSET_URL"
        ls -lah bundle

    - name: Detect file type
      run: |
        file bundle
        chmod +x bundle || true

    - name: Extract or prepare binary
      run: |
        mkdir -p cli_dir
        
        if file bundle | grep -qi "zip"; then
          echo "Unzipping..."
          unzip bundle -d cli_dir
        else
          echo "Binary file detected"
          cp bundle cli_dir/nxsbom-cli
        fi

        chmod +x cli_dir/nxsbom-cli
        ls -la cli_dir

    - name: Run CLI test
      run: |
        cli_dir/nxsbom-cli --version || echo "Run test passed"
