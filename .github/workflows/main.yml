name: Test nxsbom-cli (Ubuntu + Fedora + CentOS)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-cli:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            container: ""
          - os: fedora
            container: "fedora:latest"
          - os: centos
            container: "quay.io/centos/centos:stream9"

    runs-on: ${{ matrix.container == '' && matrix.os || 'ubuntu-24.04' }}
    container: ${{ matrix.container }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      ## Ubuntu direct runner installs unzip/jq
      - name: Install deps (Ubuntu host)
        if: matrix.container == ''
        run: |
          sudo apt update
          sudo apt install -y unzip jq file

      ## Fedora/CentOS install logic
      - name: Install deps (Fedora/CentOS)
        if: matrix.container != ''
        run: |
          if command -v dnf >/dev/null 2>&1; then
            echo "Fedora detected"
            dnf install -y curl jq unzip file
          elif command -v yum >/dev/null 2>&1; then
            echo "CentOS detected"
            yum install -y jq unzip file --skip-broken || true
            command -v curl >/dev/null 2>&1 || yum install -y curl-minimal --skip-broken || true
          fi

      - name: Download nxsbom-cli from GitHub Release
        run: |
          mkdir -p cli_dir
          echo "Downloading nxsbom-cli binary..."
          curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli" -o cli_dir/nxsbom-cli
          chmod +x cli_dir/nxsbom-cli
          ls -al cli_dir

      - name: Run CLI Test
        run: |
          echo "Running on OS: ${{ matrix.os }}"

          if [ "${{ matrix.os }}" = "centos" ]; then
            echo "CentOS â€“ only checking system environment"
            pwd
            ls -al
            exit 0
          fi

          cli_dir/nxsbom-cli --version || cli_dir/nxsbom-cli -h
