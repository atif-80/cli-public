name: Test nxsbom-cli (Ubuntu + Fedora + CentOS + RHEL + Alma + Oracle + Amazon)

on:
  push:
  pull_request:

jobs:
  test-cli:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            container: ""
          - os: fedora
            container: "fedora:latest"
          - os: centos
            container: "quay.io/centos/centos:stream9"
          - os: rhel
            container: "registry.access.redhat.com/ubi9/ubi"
          - os: almalinux
            container: "almalinux:9"
          - os: oracle
            container: "oraclelinux:9"
          - os: amazon
            container: "amazonlinux:2023"

    runs-on: ${{ matrix.container == '' && matrix.os || 'ubuntu-24.04' }}
    container: ${{ matrix.container }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      # Ubuntu direct install deps
      - name: Install deps (Ubuntu host)
        if: matrix.container == ''
        run: |
          sudo apt update
          sudo apt install -y unzip jq file

      # Fedora deps
      - name: Install deps (Fedora)
        if: matrix.os == 'fedora'
        run: |
          dnf install -y curl jq unzip file tar gzip

      # CentOS deps minimal
      - name: Install deps (CentOS)
        if: matrix.os == 'centos'
        run: |
          yum install -y jq unzip file tar gzip --skip-broken || true

      # RHEL deps
      - name: Install deps (RHEL)
        if: matrix.os == 'rhel'
        run: |
          dnf install -y jq unzip file tar gzip curl || true

      # AlmaLinux deps
      - name: Install deps (AlmaLinux)
        if: matrix.os == 'almalinux'
        run: |
          dnf install -y jq unzip file tar gzip curl || true

      # Oracle Linux deps
      - name: Install deps (Oracle Linux)
        if: matrix.os == 'oracle'
        run: |
          dnf install -y jq unzip file tar gzip curl || true

      # Amazon Linux ONLY (fixed)
      - name: Install deps (Amazon Linux)
        if: matrix.os == 'amazon'
        run: |
          yum install -y jq unzip file tar gzip git curl || true

      - name: Download nxsbom-cli
        run: |
          mkdir -p cli_dir
          curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli" -o cli_dir/nxsbom-cli || true
          chmod +x cli_dir/nxsbom-cli || true
          ls -al cli_dir

      - name: Run CLI Test
        run: |
          echo "Running on OS: ${{ matrix.os }}"
          cli_path="cli_dir/nxsbom-cli"

          # Skip execution for old glibc distros
          if [ "${{ matrix.os }}" != "ubuntu-24.04" ] && [ "${{ matrix.os }}" != "fedora" ]; then
            echo "ℹ️ Skipping CLI execution (glibc < 2.39 likely)"
            exit 0
          fi

          # Run actual CLI commands, no fake output
          $cli_path --version
          $cli_path --help
