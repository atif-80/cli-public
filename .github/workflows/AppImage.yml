name: Test nxsbom-cli AppImage (Multi-Distro Matrix)

on:
  workflow_dispatch:

  push:
    paths:
      - ".github/workflows/test-AppImage.yml"
      - "releases/**"

  pull_request:
    paths:
      - ".github/workflows/test-AppImage.yml"

jobs:
  test-cli-appimage:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            container: ""
            fatal: false

          - os: debian
            container: "debian:latest"
            fatal: false

          - os: fedora
            container: "fedora:latest"
            fatal: false

          - os: arch
            container: "archlinux:latest"
            fatal: false

          - os: kali
            container: "kalilinux/kali-rolling"
            fatal: false

          # ---- Known GLIBC incompatibles ----
          - os: centos
            container: "quay.io/centos/centos:stream9"
            fatal: true

          - os: rhel
            container: "registry.access.redhat.com/ubi9/ubi"
            fatal: true

          - os: alma
            container: "almalinux:latest"
            fatal: true

          - os: oracle
            container: "oraclelinux:9"
            fatal: true

          - os: rocky
            container: "rockylinux:9"
            fatal: true

          # ---- Package manager issues ----
          - os: amazon
            container: "amazonlinux:2023"
            fatal: true

          - os: opensuse
            container: "opensuse/leap:latest"
            fatal: true

          # ---- AppImage fundamentally incompatible ----
          - os: alpine
            container: "alpine:latest"
            fatal: true

          - os: clearlinux
            container: "clearlinux:latest"
            fatal: true

    runs-on: ${{ matrix.container == '' && matrix.os || 'ubuntu-24.04' }}
    container: ${{ matrix.container }}
    continue-on-error: ${{ matrix.fatal }}

    steps:
      - name: Pre-install Clear Linux base bundles
        if: matrix.os == 'clearlinux'
        run: |
          swupd update -y || true
          swupd bundle-add os-core os-core-dev c-basic gcc-libs \
            python-basic curl wget tar gzip unzip jq libstdc++ fuse || true

      - name: Pre-install Amazon missing tools
        if: matrix.os == 'amazon'
        run: |
          yum install -y tar gzip which || true

      - name: Pre-install openSUSE missing tools
        if: matrix.os == 'opensuse'
        run: |
          zypper refresh || true
          zypper -n install tar gzip which || true

      - name: Install deps (APT-based)
        if: matrix.os == 'ubuntu-24.04' || matrix.os == 'debian' || matrix.os == 'kali'
        run: |
          apt update || true
          apt install -y curl jq file fuse3 squashfs-tools || true

      - name: Install deps (Fedora)
        if: matrix.os == 'fedora'
        run: |
          dnf install -y curl jq file fuse fuse-libs squashfs-tools || true

      - name: Install deps (Arch)
        if: matrix.os == 'arch'
        run: |
          pacman -Sy --noconfirm curl jq file fuse2 squashfs-tools || true

      - name: Install deps (RHEL/CentOS/Alma/Rocky/Oracle)
        if: matrix.os == 'centos' || matrix.os == 'rhel' || matrix.os == 'alma' || matrix.os == 'oracle' || matrix.os == 'rocky'
        run: |
          yum install -y curl jq file fuse fuse-libs squashfs-tools || true

      - name: Install deps (Alpine — partial only)
        if: matrix.os == 'alpine'
        run: |
          apk update
          apk add --no-cache curl jq file fusermount fuse2 squashfs-tools gcompat || true
          echo "NOTE: Alpine is musl; AppImage will fail."

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download AppImage
        run: |
          mkdir -p cli_dir
          curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-e594b4d-dev-x86_64.AppImage" \
            -o cli_dir/nxsbom-cli.AppImage
          chmod +x cli_dir/nxsbom-cli.AppImage
          ls -lh cli_dir

      - name: Attempt native AppImage run
        id: native
        run: |
          echo ">>> Attempting native AppImage run"
          ./cli_dir/nxsbom-cli.AppImage -h || true

      - name: Extract AppImage fallback
        run: |
          echo ">>> Native failed — extracting AppImage"
          ./cli_dir/nxsbom-cli.AppImage --appimage-extract || true
          ls -R squashfs-root || true

      - name: Run extracted AppRun
        run: |
          if [ -f squashfs-root/AppRun ]; then
            echo ">>> Running extracted AppRun"
            chmod +x squashfs-root/AppRun || true
            ./squashfs-root/AppRun -h || true
          else
            echo "❌ AppRun not found"
          fi

      - name: Summary
        run: |
          echo "Finished testing AppImage on: ${{ matrix.os }}"
