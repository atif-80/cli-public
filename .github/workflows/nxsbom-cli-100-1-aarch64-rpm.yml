name: Test nxsbom-cli AARCH64 RPM on ARM64 distros

on:
  workflow_dispatch:

jobs:
  test-aarch64-rpm:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: fedora
            image: fedora:latest
            pkgmgr: dnf

          - name: centos
            image: quay.io/centos/centos:stream9
            pkgmgr: yum

          - name: rhel
            image: registry.access.redhat.com/ubi9/ubi
            pkgmgr: yum

          - name: alma
            image: almalinux:9
            pkgmgr: yum

          - name: rocky
            image: rockylinux:9
            pkgmgr: yum

          - name: oracle
            image: oraclelinux:9
            pkgmgr: yum

    steps:
      # --------------------------
      # Enable ARM64 via QEMU
      # --------------------------
      - name: Enable ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      # --------------------------
      # Run each ARM64 distro
      # --------------------------
      - name: Run ARM64 container test
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ matrix.image }}
          options: "--platform linux/arm64"
          run: |
            echo "===== Testing on ${{ matrix.name }} ====="
            uname -a || true
            cat /etc/os-release || true

            # Install dependencies
            if [ "${{ matrix.pkgmgr }}" = "dnf" ]; then
              dnf -y install tar gzip curl jq file libstdc++.so.6 || true
            else
              yum -y install tar gzip curl jq file libstdc++.so.6 || true
            fi

            # Download RPM
            mkdir -p cli_dir
            curl -L "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli-1.0.0-1.aarch64.rpm" \
              -o cli_dir/nxsbom-cli.rpm

            echo "Files downloaded:"
            ls -lh cli_dir

            # Install RPM
            if [ "${{ matrix.pkgmgr }}" = "dnf" ]; then
              dnf install -y ./cli_dir/nxsbom-cli.rpm || true
            else
              yum install -y ./cli_dir/nxsbom-cli.rpm || true
            fi

            # Locate installed binary
            BIN=$(command -v nxsbom || true)
            echo "Binary path: $BIN"

            if [ -z "$BIN" ]; then
              echo "âŒ Binary not found (wrong arch or glibc mismatch)"
              exit 1
            fi

            # Run smoke test
            echo ">>> Running nxsbom --help"
            $BIN --help || $BIN -h || true

            echo "----- Completed distro: ${{ matrix.name }} -----"
