name: Test nxsbom-cli AARCH64 RPM on ARM64 distros

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/test-aarch64-rpm.yml"
  pull_request:
    paths:
      - ".github/workflows/test-aarch64-rpm.yml"

jobs:
  test-aarch64-rpm:
    name: "Test AARCH64 RPM on ${{ matrix.distro }}"

    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: fedora
            image: "fedora:39-aarch64"
            pkgmgr: dnf

          - distro: rocky
            image: "rockylinux:9-aarch64"
            pkgmgr: yum

          - distro: alma
            image: "almalinux:9-aarch64"
            pkgmgr: yum

          - distro: oracle
            image: "oraclelinux:9-aarch64"
            pkgmgr: yum

          - distro: centos
            image: "quay.io/centos/centos:stream9-aarch64"
            pkgmgr: yum

          - distro: amazon
            image: "public.ecr.aws/amazonlinux/amazonlinux:2023-aarch64"
            pkgmgr: yum

          - distro: opensuse
            image: "opensuse/leap:15.6-aarch64"
            pkgmgr: zypper

    steps:
      ##########################################################
      # Enable QEMU ARM64 emulation
      ##########################################################
      - name: Enable QEMU multi-arch
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      ##########################################################
      # Start ARM64 container
      ##########################################################
      - name: Start ARM64 container
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ matrix.image }}
          options: --platform=linux/arm64
          run: |
            echo "Running on ARM64 container: ${{ matrix.distro }}"
            uname -a
            cat /etc/os-release || true

            ######################################################
            # Install required dependencies
            ######################################################
            if [ "${{ matrix.pkgmgr }}" = "dnf" ]; then
              dnf -y install curl jq file which tar gzip shadow-utils || true
            elif [ "${{ matrix.pkgmgr }}" = "yum" ]; then
              yum -y install curl jq file which tar gzip shadow-utils || true
            elif [ "${{ matrix.pkgmgr }}" = "zypper" ]; then
              zypper refresh || true
              zypper --non-interactive install curl jq file which tar gzip shadow || true
            fi

            ######################################################
            # Download the AARCH64 RPM
            ######################################################
            mkdir -p cli_dir
            curl -L \
              "https://github.com/atif-80/cli-public/releases/download/v1.0/nxsbom-cli-1.0.0-1.aarch64.rpm" \
              -o cli_dir/nxsbom-cli-aarch64.rpm

            ls -lh cli_dir

            ######################################################
            # Install AARCH64 RPM
            ######################################################
            if [ "${{ matrix.pkgmgr }}" = "dnf" ]; then
              dnf install -y cli_dir/nxsbom-cli-aarch64.rpm || true
            elif [ "${{ matrix.pkgmgr }}" = "yum" ]; then
              yum install -y cli_dir/nxsbom-cli-aarch64.rpm || true
            elif [ "${{ matrix.pkgmgr }}" = "zypper" ]; then
              zypper --non-interactive install cli_dir/nxsbom-cli-aarch64.rpm || true
            fi

            ######################################################
            # Verify binary
            ######################################################
            BIN=$(command -v nxsbom || true)
            echo "Binary found: $BIN"

            if [ -z "$BIN" ]; then
              echo "‚ùå Binary not installed (architecture mismatch?)"
              exit 1
            fi

            echo "Running --help"
            $BIN --help || $BIN --version || true

